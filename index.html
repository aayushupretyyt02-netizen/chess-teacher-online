<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Chess Trainer</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* All CSS from style.css is here */

        /* An elite, professional, and highly attractive UI */
        @keyframes aurora {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0D1117; /* A deep, dark, almost black color */
            color: #C9D1D9; /* A soft off-white for text */
            overflow-x: hidden;
            min-height: 100vh; /* Ensure body takes full viewport height */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* The new "Aurora" background effect */
        .aurora-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background:
                radial-gradient(ellipse at top, transparent 50%, rgba(29, 78, 216, 0.15)),
                radial-gradient(ellipse at bottom, transparent 50%, rgba(107, 33, 168, 0.15));
            animation: aurora 20s infinite linear;
            z-index: 0;
        }

        /* Main container to ensure content is above the aurora */
        .main-container {
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 7xl;
            margin-left: auto;
            margin-right: auto;
            display: flex; /* Flex container for header and main grid */
            flex-direction: column;
        }

        /* Command Center Panel */
        .command-center {
            background: rgba(13, 17, 23, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }

        .form-select, .btn {
            background-color: #21262D;
            border: 1px solid #30363D;
            transition: all 0.2s ease-in-out;
            color: #C9D1D9; /* Ensure text color is consistent */
        }
        .form-select:focus, .btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(45, 128, 255, 0.6);
            border-color: #2F81F7;
        }
        .btn:hover {
            background-color: #30363D;
            transform: translateY(-2px);
        }
        .btn:active {
            transform: translateY(0);
        }
        .start-btn {
             background-color: #238636;
             border-color: #2EA043;
        }
        .start-btn:hover {
            background-color: #2EA043;
        }
        .start-bot-btn { /* This button will now serve as "Start 2-Player" if needed */
            background-color: #1a73e8; /* Google Blue-ish */
            border-color: #1764cc;
        }
        .start-bot-btn:hover {
            background-color: #1764cc;
        }
        .undo-btn { /* New style for undo button */
            background-color: #d97706; /* Amber */
            border-color: #b45309;
        }
        .undo-btn:hover {
            background-color: #b45309;
        }


        /* New styles for evaluation display */
        #evaluation-display {
            font-size: 1.1rem;
            font-weight: 500;
            margin-top: 8px;
            color: #c9d1d9; /* Soft off-white */
            min-height: 24px; /* Ensure space even if empty */
        }
        .eval-white {
            color: #6ee7b7; /* Greenish for White advantage */
        }
        .eval-black {
            color: #ef4444; /* Reddish for Black advantage */
        }
        .eval-even {
            color: #60a5fa; /* Blue for even */
        }

        /* Move Quality Feedback - No AI, so these classes might not be actively used, but kept for future expansion */
        .feedback-blunder { color: #f87171; font-weight: bold; } /* Red */
        .feedback-mistake { color: #facc15; font-weight: bold; } /* Yellow */
        .feedback-inaccuracy { color: #fdba74; } /* Orange */
        .feedback-good { color: #a3e635; } /* Light green */
        .feedback-best { color: #34d399; font-weight: bold; } /* Emerald green */
        .feedback-book { color: #60a5fa; } /* Blue for book moves */


        .highlight-correct {
            box-shadow: 0 0 25px 8px rgba(34, 197, 94, 0.7);
        }
        .highlight-incorrect {
            box-shadow: 0 0 25px 8px rgba(239, 68, 68, 0.7);
        }
        .highlight-selected {
            background: rgba(45, 128, 255, 0.5) !important;
        }
        .highlight-legal-move { /* New style for legal move highlights */
            background: rgba(0, 200, 0, 0.2) !important; /* Semi-transparent green */
        }


        /* Win Meter Bar - No AI, so this will mostly stay 50/50, but kept for visual structure */
        .board-container {
            position: relative;
            display: flex; /* Use flex to align board and meter */
            align-items: flex-start; /* Align to top */
            gap: 16px; /* Space between board and meter */
            width: 100%; /* Take full width of parent */
            justify-content: center; /* Center board and meter */
        }

        #win-meter {
            width: 20px; /* Width of the meter bar */
            min-height: 200px; /* Minimum height for visibility */
            background-color: #21262D; /* Default background */
            border-radius: 5px;
            overflow: hidden; /* Hide anything outside */
            display: flex;
            flex-direction: column; /* To make white/black parts stack */
            justify-content: flex-end; /* White portion grows from bottom */
            position: relative; /* For absolute positioning of text */
            flex-shrink: 0; /* Prevent meter from shrinking */
        }

        /* Adjust meter height to match board */
        #win-meter {
            height: var(--board-size, 400px); /* Use a CSS variable for dynamic height */
        }

        .meter-fill-white {
            background-color: #F8F8F8; /* White color for meter fill */
            width: 100%;
            transition: height 0.3s ease-in-out; /* Smooth transition */
            position: absolute; /* Allows precise positioning */
            bottom: 0;
            left: 0;
        }
        .meter-fill-black {
            background-color: #30363D; /* Darker color for black fill */
            width: 100%;
            transition: height 0.3s ease-in-out;
            position: absolute;
            top: 0;
            left: 0;
        }

        .meter-text {
            position: absolute;
            font-size: 0.8rem;
            color: #c9d1d9;
            font-weight: bold;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2; /* Above the fills */
            text-shadow: 0 0 2px black; /* For readability */
        }
        .meter-white-text { bottom: 5px; }
        .meter-black-text { top: 5px; }

        /* Mobile specific adjustments */
        @media (max-width: 1023px) { /* Adjust for smaller screens like phones/tablets */
            .main-container {
                padding: 1rem; /* Add padding to main container */
            }
            .grid {
                grid-template-columns: 1fr; /* Single column layout for mobile */
            }
            .command-center {
                order: 2; /* Move controls below board/status */
                margin-top: 1rem;
            }
            .lg\:col-span-1 { /* Override larger screen settings */
                width: 100%;
            }
            .board-container {
                flex-direction: column; /* Stack board and meter vertically */
                align-items: center; /* Center them */
                gap: 0.5rem; /* Reduce gap */
            }
            #win-meter {
                width: 100%; /* Make meter horizontal */
                height: 20px; /* Fixed height for horizontal bar */
                flex-direction: row; /* For horizontal stack */
                justify-content: flex-start; /* White portion grows from left */
                order: 1; /* Place meter above board */
            }
            #myBoard {
                order: 2; /* Place board below meter */
            }
            .meter-fill-white, .meter-fill-black {
                height: 100%; /* Fill full height of horizontal bar */
                width: 0; /* Will be set dynamically by JS */
            }
            .meter-fill-white { right: 0; left: auto; } /* White grows from left (but applied to right side) */
            .meter-fill-black { left: 0; }
            .meter-text { top: 50%; transform: translate(-50%, -50%); } /* Center text vertically */
            .meter-white-text { left: auto; right: 5px; } /* Adjust position for horizontal */
            .meter-black-text { left: 5px; }

            /* Buttons layout for mobile */
            .command-center .grid {
                grid-template-columns: 1fr; /* Stack buttons vertically */
                gap: 0.75rem;
            }
            .command-center .grid button {
                width: 100%; /* Full width buttons */
            }
            /* Move start-bot-btn to the end for mobile view */
            #start-bot-btn {
                order: 4; /* Place it last in the grid for mobile */
                margin-top: 1rem; /* Add some space above it */
            }
            #reset-btn {
                order: 3; /* Place reset before start-bot */
            }
            #undo-btn { /* New Undo button mobile positioning */
                order: 2;
            }
            #start-btn {
                order: 1;
            }
        }

    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 md:p-6">

    <div class="aurora-background"></div>
    <div class="main-container w-full max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-white tracking-wide">Chess Opening Trainer</h1>
            <p class="text-lg text-slate-400 mt-2">The definitive tool to master your openings.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="lg:col-span-1 w-full p-6 command-center shadow-2xl">
                <h2 class="text-2xl font-bold mb-5 border-b border-slate-700 pb-3 text-white">Training Setup</h2>

                <div class="space-y-5">
                    <div>
                        <label for="player-color-select" class="block text-sm font-medium text-slate-300 mb-2">Your Color:</label>
                        <select id="player-color-select" class="form-select w-full p-2.5 rounded-lg text-white">
                            <option value="w">White</option>
                            <option value="b">Black</option>
                        </select>
                    </div>
                    <div>
                        <label for="category-select" class="block text-sm font-medium text-slate-300 mb-2">Opening Category:</label>
                        <select id="category-select" class="form-select w-full p-2.5 rounded-lg text-white"></select>
                    </div>
                     <div>
                        <label for="opening-select" class="block text-sm font-medium text-slate-300 mb-2">Specific Opening:</label>
                        <select id="opening-select" class="form-select w-full p-2.5 rounded-lg text-white"></select>
                    </div>
                     <div>
                        <label for="variation-select" class="block text-sm font-medium text-slate-300 mb-2">Variation:</label>
                        <select id="variation-select" class="form-select w-full p-2.5 rounded-lg text-white"></select>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-2 gap-4 mt-6">
                    <button id="start-btn" class="btn start-btn w-full py-3 px-4 rounded-lg font-semibold text-white shadow-lg">Start Practice</button>
                    <button id="undo-btn" class="btn undo-btn w-full py-3 px-4 rounded-lg font-semibold text-white">Undo Last Move</button>
                    <button id="reset-btn" class="btn w-full py-3 px-4 rounded-lg font-semibold text-white">Reset Board</button>
                    <button id="start-bot-btn" class="btn start-bot-btn w-full py-3 px-4 rounded-lg font-semibold text-white shadow-lg col-span-2" style="display: none;">Start Two-Player Mode</button>
                </div>
            </div>

            <div class="lg:col-span-1">
                <div id="status" class="w-full p-4 mb-4 bg-slate-800 rounded-lg text-center shadow-md">
                    <p class="font-semibold text-xl" id="status-opening">Welcome!</p>
                    <p class="text-md text-slate-400" id="status-move">Select an opening and start your practice.</p>
                    <div id="evaluation-display" class="mt-2 text-sm"></div>
                </div>
                <div class="board-container">
                    <div id="myBoard" class="w-full rounded-lg shadow-2xl"></div>
                    <div id="win-meter">
                        <div class="meter-fill-white"></div>
                        <div class="meter-fill-black"></div>
                        <span class="meter-text meter-white-text"></span>
                        <span class="meter-text meter-black-text"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.min.js"></script>

    <script>
        // All JavaScript is here
        // Use jQuery's ready function for more reliable DOM loading
        $(function() { 
            // --- Interactive Aura Effect ---
            const body = document.body;
            const updateAura = (x, y) => {
                body.style.setProperty('--mouse-x', `${x}px`);
                body.style.setProperty('--mouse-y', `${y}px`);
            };
            document.addEventListener('mousemove', e => updateAura(e.clientX, e.clientY));
            document.addEventListener('touchmove', e => e.touches.length > 0 && updateAura(e.touches[0].clientX, e.touches[0].clientY));
            document.addEventListener('touchstart', e => e.touches.length > 0 && updateAura(e.touches[0].clientX, e.touches[0].clientY));

            // --- Chess Logic ---
            if (typeof window.jQuery === 'undefined') {
                alert("Error: jQuery library failed to load. Please check your internet connection and refresh.");
                return;
            }

            const $ = window.jQuery;

            let board = null;
            let game = new Chess();
            let currentOpeningMoves = [];
            let currentMoveIndex = 0;
            let playerColor = 'w'; // Default player is White (as computer color selection removed)
            let twoPlayerModeActive = false; // Flag for 2-player mode
            let thinkingProcess = null; // To store timeout for computer thinking or move processing (kept for general timeouts)

            // --- AI/API related variables removed ---
            // prevEvalCp, prevBestMoveSAN, currentApiTaskId, chessApiWs, CHESS_API_URL, apiCallbacks are removed.
            // Evaluation and feedback will be purely visual (0.00) or based on predefined text.

            // DOM Elements
            const $statusOpening = $('#status-opening');
            const $statusMove = $('#status-move');
            const $boardElement = $('#myBoard');
            const $playerColorSelect = $('#player-color-select');
            // $computerColorSelect removed
            const $categorySelect = $('#category-select');
            const $openingSelect = $('#opening-select');
            const $variationSelect = $('#variation-select');
            const $startBtn = $('#start-btn');
            const $resetBtn = $('#reset-btn');
            const $undoBtn = $('#undo-btn'); 
            const $startTwoPlayerBtn = $('#start-bot-btn'); // Renamed to reflect 2-player purpose
            const $evaluationDisplay = $('#evaluation-display'); // Will mostly show 0.00
            const $winMeter = $('#win-meter'); // Will mostly show 50/50
            const $winMeterWhiteFill = $winMeter.find('.meter-fill-white');
            const $winMeterBlackFill = $winMeter.find('.meter-fill-black');
            const $winMeterWhiteText = $winMeter.find('.meter-white-text');
            const $winMeterBlackText = $winMeter.find('.meter-black-text');

            // --- API Connection Function (REMOVED) ---
            // connectChessApiWs, sendEngineRequest are removed

            // --- Opening Book Data (RIGOROUSLY VERIFIED & CORRECTED) ---
            const openingBook = {
                "King's Pawn (e4)": {
                    "Italian Game": {
                        "Giuoco Piano": ['e4', 'e5', 'Nf3', 'Nc6', 'Bc4', 'Bc5', 'c3', 'Nf6', 'd4', 'exd4', 'cxd4', 'Bb4+', 'Nc3', 'Nxe4', 'O-O', 'Bxc3+', 'bxc3', 'd5', 'Bd3', 'O-O', 'c4'],
                        "Evans Gambit": ['e4', 'e5', 'Nf3', 'Nc6', 'Bc4', 'Bc5', 'b4', 'Bxb4', 'c3', 'Ba5', 'd4', 'exd4', 'O-O', 'dxc3', 'Qb3', 'Qf6', 'e5', 'Qg6', 'Nxc3', 'Nge7'],
                        "Fried Liver Attack": ['e4', 'e5', 'Nf3', 'Nc6', 'Bc4', 'Nf6', 'Ng5', 'd5', 'exd5', 'Nxd5', 'Nxf7', 'Kxf7', 'Qf3+', 'Ke6', 'Nc3', 'Ncb4', 'a3', 'Nxc2+', 'Kd1']
                    },
                    "Ruy Lopez": {
                        "Morphy Defense": ['e4', 'e5', 'Nf3', 'Nc6', 'Bb5', 'a6', 'Ba4', 'Nf6', 'O-O', 'Be7', 'Re1', 'b5', 'Bb3', 'd6', 'c3', 'O-O', 'h3', 'Na5', 'Bc2', 'c5'],
                        "Exchange Variation": ['e4', 'e5', 'Nf3', 'Nc6', 'Bb5', 'a6', 'Bxc6', 'dxc6', 'O-O', 'f6', 'd4', 'exd4', 'Nxd4', 'Ne7', 'Re1', 'Ng6', 'Nd2', 'c5'],
                        "Berlin Defense": ['e4', 'e5', 'Nf3', 'Nc6', 'Bb5', 'Nf6', 'O-O', 'Nxe4', 'd4', 'Nd6', 'Bxc6', 'dxc6', 'dxe5', 'Nf5', 'Qxd8+', 'Kxd8', 'Nc3', 'Ke8']
                    },
                    "Scotch Game": {
                        "Main Line": ['e4', 'e5', 'Nf3', 'Nc6', 'd4', 'exd4', 'Nxd4', 'Nf6', 'Nc3', 'Bb4', 'Nxc6', 'bxc6', 'Bd3', 'd5', 'exd5', 'cxd5', 'O-O'],
                        "Scotch Gambit": ['e4', 'e5', 'Nf3', 'Nc6', 'd4', 'exd4', 'Bc4', 'Nf6', 'O-O', 'Nxe4', 'Re1', 'd5', 'Bxd5', 'Qxd5', 'Nc3']
                    },
                    "Petrov Defense": {
                        "Classical Variation": ['e4', 'e5', 'Nf3', 'Nf6', 'Nxe5', 'd6', 'Nf3', 'Nxe4', 'd4', 'd5', 'Bd3', 'Bd6', 'O-O', 'O-O', 'c4', 'c6', 'Re1'],
                        "Modern Attack": ['e4', 'e5', 'Nf3', 'Nf6', 'Nxe5', 'd6', 'Nf3', 'Nxe4', 'Nc3', 'Nxc3', 'dxc3', 'Be7', 'Bd3', 'O-O', 'O-O']
                    },
                    "Sicilian Defense": {
                        "Najdorf Variation": ['e4', 'c5', 'Nf3', 'd6', 'd4', 'cxd4', 'Nxd4', 'Nf6', 'Nc3', 'a6', 'Be3', 'e5', 'Nb3', 'Be7', 'f3', 'Be6', 'Qd2', 'O-O', 'O-O-O'],
                        "Dragon Variation": ['e4', 'c5', 'Nf3', 'd6', 'd4', 'cxd4', 'Nxd4', 'Nf6', 'Nc3', 'g6', 'Be3', 'Bg7', 'f3', 'Nc6', 'Qd2', 'O-O', 'Bc4', 'Nxd4', 'Bxd4', 'Bd7', 'O-O-O'],
                        "Accelerated Dragon": ['e4', 'c5', 'Nf3', 'Nc6', 'd4', 'cxd4', 'Nxd4', 'g6', 'Nc3', 'Bg7', 'Be3', 'Nf6', 'Bc4', 'O-O', 'Bb3', 'd6', 'f3'],
                        "Open Sicilian (e6)": ['e4', 'c5', 'Nf3', 'e6', 'd4', 'cxd4', 'Nxd4', 'Nf6', 'Nc3', 'Nc6', 'Ndb5', 'd6', 'Bf4', 'e5', 'Bg5', 'a6', 'Na3'],
                        "Alapin Variation": ['e4', 'c5', 'c3', 'Nf6', 'e5', 'Nd5', 'd4', 'cxd4', 'cxd4', 'd6', 'Nf3', 'Nc6', 'Bc4', 'e6', 'O-O']
                    },
                    "French Defense": {
                        "Advance Variation": ['e4', 'e6', 'd4', 'd5', 'e5', 'c5', 'c3', 'Nc6', 'Nf3', 'Bd7', 'Be2', 'Nge7', 'O-O', 'Nf5', 'Bd3'],
                        "Exchange Variation": ['e4', 'e6', 'd4', 'd5', 'exd5', 'exd5', 'Nf3', 'Nf6', 'Bd3', 'Bd6', 'O-O', 'O-O', 'c3', 'Re8', 'Re1'],
                        "Winawer Variation": ['e4', 'e6', 'd4', 'd5', 'Nc3', 'Bb4', 'e5', 'c5', 'a3', 'Bxc3+', 'bxc3', 'Ne7', 'Qg4', 'Qc7', 'Qxg7', 'Rg8', 'Qxh7'],
                        "Classical Variation": ['e4', 'e6', 'd4', 'd5', 'Nc3', 'Nf6', 'Bg5', 'Be7', 'e5', 'Nfd7', 'Bxe7', 'Qxe7', 'f4', 'a6', 'Nf3']
                    },
                    "Caro-Kann Defense": {
                        "Classical Variation": ['e4', 'c6', 'd4', 'd5', 'Nc3', 'dxe4', 'Nxe4', 'Bf5', 'Ng3', 'Bg6', 'h4', 'h6', 'Nf3', 'e6', 'Be2'],
                        "Advance Variation": ['e4', 'c6', 'd4', 'd5', 'e5', 'Bf5', 'Nf3', 'e6', 'Be2', 'c5', 'c3', 'Nc6', 'O-O', 'Qb6', 'a3'],
                        "Panov-Botvinnik Attack": ['e4', 'c6', 'd4', 'd5', 'exd5', 'cxd5', 'c4', 'Nf6', 'Nc3', 'Nc6', 'Bg5', 'e6', 'Nf3', 'Bb4', 'cxd5', 'exd5']
                    }
                },
                "Queen's Pawn (d4)": {
                    "Queen's Gambit": {
                        "Accepted": ['d4', 'd5', 'c4', 'dxc4', 'Nf3', 'Nf6', 'e3', 'e6', 'Bxc4', 'c5', 'O-O', 'a6', 'dxc5', 'Bxc5', 'Qe2'],
                        "Declined": ['d4', 'd5', 'c4', 'e6', 'Nc3', 'Nf6', 'Bg5', 'Be7', 'e3', 'O-O', 'Nf3', 'Nbd7', 'Bd3', 'c6', 'O-O', 'h6', 'Bh4'],
                        "Tarrasch Defense": ['d4', 'd5', 'c4', 'e6', 'Nc3', 'c5', 'cxd5', 'exd5', 'Nf3', 'Nc6', 'g3', 'Nf6', 'Bg2', 'Be7', 'O-O'],
                        "Slav Defense": ['d4', 'd5', 'c4', 'c6', 'Nc3', 'Nf6', 'Nf3', 'e6', 'e3', 'Nbd7', 'Bd3', 'dxc4', 'Bxc4', 'b5', 'Bd3'],
                        "Semi-Slav Defense": ['d4', 'd5', 'c4', 'c6', 'Nf3', 'Nf6', 'Nc3', 'e6', 'e3', 'Nbd7', 'Bd3', 'dxc4', 'Bxc4', 'Bd6', 'O-O']
                    },
                    "London System": {
                        "Main Line": ['d4', 'd5', 'Bf4', 'Nf6', 'e3', 'c5', 'c3', 'Nc6', 'Nd2', 'Qb6', 'Rb1', 'Bf5', 'Ngf3', 'e6', 'Qb3'],
                        "Jobava London": ['d4', 'Nf6', 'Nc3', 'd5', 'Bf4', 'Bf5', 'e3', 'e6', 'Nf3', 'c6', 'Ne5', 'Nbd7', 'g4', 'Nxe5', 'gxf5']
                    },
                    "King's Indian Defense": {
                        "Classical Variation": ['d4', 'Nf6', 'c4', 'g6', 'Nc3', 'Bg7', 'e4', 'd6', 'Nf3', 'O-O', 'Be2', 'e5', 'O-O', 'Nc6', 'd5', 'Ne7', 'Ne1', 'Nd7'],
                        "Sämisch Variation": ['d4', 'Nf6', 'c4', 'g6', 'Nc3', 'Bg7', 'e4', 'd6', 'f3', 'O-O', 'Be3', 'c5', 'd5', 'e6', 'Bd3'],
                        "Fianchetto Variation": ['d4', 'Nf6', 'c4', 'g6', 'g3', 'Bg7', 'Bg2', 'd6', 'Nf3', 'O-O', 'Nc3', 'Nbd7', 'O-O', 'e5', 'e4']
                    },
                    "Nimzo-Indian Defense": {
                        "Rubinstein Variation": ['d4', 'Nf6', 'c4', 'e6', 'Nc3', 'Bb4', 'e3', 'O-O', 'Nf3', 'd5', 'Bd3', 'c5', 'O-O', 'dxc4', 'Bxc4'],
                        "Classical Variation": ['d4', 'Nf6', 'c4', 'e6', 'Nc3', 'Bb4', 'Qc2', 'd5', 'a3', 'Bxc3+', 'Qxc3', 'c5', 'dxc5', 'Nbd7', 'cxd5'],
                        "Leningrad Variation": ['d4', 'Nf6', 'c4', 'e6', 'Nc3', 'Bb4', 'Bg5', 'h6', 'Bh4', 'c5', 'e3', 'g5', 'Bg3']
                    },
                    "Grünfeld Defense": {
                        "Exchange Variation": ['d4', 'Nf6', 'c4', 'g6', 'Nc3', 'd5', 'cxd5', 'Nxd5', 'e4', 'Nxc3', 'bxc3', 'Bg7', 'Bc4', 'c5', 'Ne2', 'Nc6', 'Be3'],
                        "Russian System": ['d4', 'Nf6', 'c4', 'g6', 'Nc3', 'd5', 'Qb3', 'dxc4', 'Qxc4', 'Bg7', 'e4', 'O-O', 'Nf3', 'c6', 'Be2']
                    },
                    "Benoni Defense": {
                        "Modern Benoni": ['d4', 'Nf6', 'c4', 'c5', 'd5', 'e6', 'Nc3', 'exd5', 'cxd5', 'd6', 'e4', 'g6', 'Nf3', 'Bg7', 'Be2', 'O-O', 'O-O'],
                        "Czech Benoni": ['d4', 'c5', 'd5', 'e5', 'e4', 'd6', 'Nc3', 'Nf6', 'f4', 'exf4', 'Bxf4', 'Be7', 'Nf3']
                    }
                },
                "Flank Openings": {
                    "English Opening": {
                        "Symmetrical Variation": ['c4', 'c5', 'Nc3', 'Nc6', 'g3', 'g6', 'Bg2', 'Bg7', 'Nf3', 'Nf6', 'O-O', 'O-O', 'Rb1', 'd6', 'a3'],
                        "Reversed Sicilian": ['c4', 'e5', 'Nc3', 'Nf6', 'g3', 'd5', 'cxd5', 'Nxd5', 'Bg2', 'Be6', 'Nf3', 'Nc6', 'O-O', 'Be7', 'd3'],
                        "Four Knights Variation": ['c4', 'e5', 'Nc3', 'Nf6', 'Nf3', 'Nc6', 'g3', 'Bb4', 'Bg2', 'O-O', 'O-O', 'Re8', 'Nd5', 'Nxd5', 'cxd5', 'e4', 'Ne1']
                    },
                    "Réti Opening": {
                        "Main Line": ['Nf3', 'd5', 'c4', 'd4', 'b4', 'f6', 'e3', 'e5', 'exd4', 'exd4', 'Bd3', 'Bxb4', 'O-O', 'Ne7', 'Nbd2'],
                        "King's Indian Attack": ['Nf3', 'Nf6', 'g3', 'd5', 'Bg2', 'c5', 'O-O', 'Nc6', 'd3', 'e5', 'Nbd2', 'Be7', 'e4', 'd4', 'a4']
                    },
                    "Bird's Opening": {
                        "Main Line": ['f4', 'd5', 'Nf3', 'Nf6', 'e3', 'e6', 'b3', 'c5', 'Bb2', 'Nc6', 'Bb5', 'Bd7', 'O-O'],
                        "From Gambit": ['f4', 'e5', 'fxe5', 'd6', 'exd6', 'Bxd6', 'Nf3', 'g5', 'g3', 'g4', 'Nd4', 'Be5', 'e3']
                    },
                    "Larsen's Opening": {
                        "Main Line": ['b3', 'e5', 'Bb2', 'Nc6', 'e3', 'Nf6', 'Bb5', 'Bd6', 'Ne2', 'O-O', 'O-O', 'Re8', 'Ng3'],
                        "Modern Variation": ['b3', 'd5', 'Bb2', 'Nf6', 'Nf3', 'c5', 'e3', 'Nc6', 'Bb5', 'Bd7', 'O-O', 'e6', 'Bxc6', 'Bxc6']
                    }
                },
                "Indian Defenses (Other)": {
                    "Queen's Indian Defense": {
                        "Main Line": ['d4', 'Nf6', 'c4', 'e6', 'Nf3', 'b6', 'g3', 'Bb7', 'Bg2', 'Be7', 'O-O', 'O-O', 'Nc3', 'Ne4', 'Bd2'],
                        "Nimzowitsch Variation": ['d4', 'Nf6', 'c4', 'e6', 'Nf3', 'b6', 'Nc3', 'Bb7', 'Bg5', 'Be7', 'e3', 'O-O', 'Be2']
                    },
                    "Bogo-Indian Defense": {
                        "Main Line": ['d4', 'Nf6', 'c4', 'e6', 'Nf3', 'Bb4+', 'Bd2', 'a5', 'g3', 'd6', 'Bg2', 'Bxd2+', 'Qxd2', 'O-O', 'Nc3'],
                        "Queen-side Fianchetto": ['d4', 'Nf6', 'c4', 'e6', 'Nf3', 'Bb4+', 'Nbd2', 'O-O', 'a3', 'Bxd2+', 'Qxd2', 'b6', 'g3']
                    }
                }
            };

            function populateCategories() {
                $categorySelect.empty();
                for (const category in openingBook) { $categorySelect.append($('<option>', { value: category, text: category })); }
                $categorySelect.trigger('change');
            }

            function populateOpenings() {
                const selectedCategory = $categorySelect.val();
                $openingSelect.empty();
                if (openingBook[selectedCategory]) {
                    for (const opening in openingBook[selectedCategory]) { $openingSelect.append($('<option>', { value: opening, text: opening })); }
                }
                $openingSelect.trigger('change');
            }

            function populateVariations() {
                const selectedCategory = $categorySelect.val();
                const selectedOpening = $openingSelect.val();
                $variationSelect.empty();
                if(openingBook[selectedCategory] && openingBook[selectedCategory][selectedOpening]) {
                    for (const variation in openingBook[selectedCategory][selectedOpening]) { $variationSelect.append($('<option>', { value: variation, text: variation })); }
                }
            }

            $categorySelect.on('change', populateOpenings);
            $openingSelect.on('change', populateVariations);

            // Function to display evaluation feedback (will mostly be "Even" now)
            function displayEvaluation(evalCp, winChance, mate, statusMessage = null) {
                // In pure 2-player mode, we don't display AI eval, just "Game"
                $evaluationDisplay.empty().removeClass('eval-white eval-black eval-even');
                $winMeterWhiteText.text('');
                $winMeterBlackText.text('');
                updateWinMeter(50); // Keep meter centered for 2-player mode

                if (statusMessage) { 
                    $evaluationDisplay.text(statusMessage);
                } else {
                    $evaluationDisplay.text('Game In Progress'); 
                }
            }

            // Function to update the graphical win meter (will mostly stay 50/50 now)
            function updateWinMeter(winChance) {
                const whiteWinPercentage = winChance;
                const blackWinPercentage = 100 - winChance;

                // Adjust meter height to chessboard size
                const boardHeight = $('#myBoard').height();
                if (boardHeight > 0) {
                    $winMeter.css('--board-size', `${boardHeight}px`);
                }

                // Check if it's a mobile layout (horizontal meter) based on actual CSS media query match
                if (window.matchMedia("(max-width: 1023px)").matches) {
                    $winMeterWhiteFill.css('width', `${whiteWinPercentage}%`);
                    $winMeterBlackFill.css('width', `${blackWinPercentage}%`);
                    $winMeterWhiteFill.css('height', '100%'); 
                    $winMeterBlackFill.css('height', '100%'); 
                    $winMeterWhiteText.text(whiteWinPercentage.toFixed(0) + '%');
                    $winMeterBlackText.text(blackWinPercentage.toFixed(0) + '%');
                } else { // Desktop layout (vertical meter)
                    $winMeterWhiteFill.css('height', `${whiteWinPercentage}%`);
                    $winMeterBlackFill.css('height', `${blackWinPercentage}%`);
                    $winMeterWhiteFill.css('width', '100%'); 
                    $winMeterBlackFill.css('width', '100%'); 
                    $winMeterWhiteText.text(whiteWinPercentage.toFixed(0) + '%');
                    $winMeterBlackText.text(blackWinPercentage.toFixed(0) + '%');
                }
                 // Adjust text color based on background for readability
                 if (whiteWinPercentage > 70) {
                    $winMeterWhiteText.css('color', 'black');
                 } else {
                    $winMeterWhiteText.css('color', '#c9d1d9');
                 }
                 if (blackWinPercentage > 70) {
                    $winMeterBlackText.css('color', 'black');
                 } else {
                    $winMeterBlackText.css('color', '#c9d1d9');
                 }

                 // Hide percentage text if bar is too small
                 $winMeterWhiteText.toggle(whiteWinPercentage > 15);
                 $winMeterBlackText.toggle(blackWinPercentage > 15);
            }


            // Function to determine move quality feedback (Removed AI aspects)
            function getMoveQualityFeedback(prevEval, currentEval, turn, playerMoveSAN, bestMoveSAN) {
                return ''; // No AI, so no move quality feedback
            }

            // --- Click-to-Move Variables ---
            let squareSelected = null; // Stores the square of the piece clicked first

            function onSquareClick(square) {
                // If the game is over, no more moves (click or drag)
                if (game.game_over()) {
                    updateStatus("Game is over!", false);
                    return;
                }

                // --- STRICTLY: Book moves only allow playerColor to move ---
                if (currentMoveIndex < currentOpeningMoves.length) { // Still in book mode
                    if (game.turn() !== playerColor) { // Player is always White here
                        updateStatus("It's not your turn to play book moves! You are White.", false);
                        return;
                    }
                    handlePlayerMoveInBookMode(square); // Handles clicks within book mode
                    return;
                }

                // --- After book moves (Two-Player Mode) ---
                // In two-player mode, allow any valid move for the current turn's player
                if (squareSelected === null) {
                    // First click: select piece if it belongs to current turn's player
                    let piece = game.get(square);
                    if (piece && piece.color === game.turn()) { // Allow selecting for current turn (White or Black)
                        squareSelected = square;
                        $('#myBoard .square-' + square).addClass('highlight-selected');

                        // Highlight legal moves for the selected piece
                        const legalMoves = game.moves({ square: square, verbose: true });
                        legalMoves.forEach(move => {
                            $('#myBoard .square-' + move.to).addClass('highlight-legal-move');
                        });

                    } else {
                        updateStatus(`Select ${game.turn() === 'w' ? 'White' : 'Black'}'s piece!`, false);
                    }
                } else {
                    // Second click: try to move the selected piece to this square
                    // Clear previous highlights
                    $('#myBoard .square-' + squareSelected).removeClass('highlight-selected');
                    game.moves({ square: squareSelected, verbose: true }).forEach(move => {
                        $('#myBoard .square-' + move.to).removeClass('highlight-legal-move');
                    });


                    let move = game.move({
                        from: squareSelected,
                        to: square,
                        promotion: 'q' // auto-promote to queen for simplicity for now
                    });

                    squareSelected = null; // Clear selection

                    if (move === null) {
                        updateStatus("Illegal move! Try again.", false);
                        board.position(game.fen()); // Snapback visual state
                        return; 
                    } else {
                        // Valid move in two-player mode
                        board.position(game.fen()); // Update board visually
                        updateStatus(`Move: ${move.san}`);
                        if (!game.game_over()) {
                            // In 2-player mode, just switch turns
                            $statusMove.text(`Player ${game.turn() === 'w' ? 'White' : 'Black'}'s turn.`);
                        } else {
                            handleGameOver();
                        }
                    }
                }
            }

            // Centralized function for handling player moves in Opening Trainer book mode (both drag and click)
            function handlePlayerMoveInBookMode(source, target = null) {
                let moveResult;
                const currentFenBeforeMove = game.fen(); // Store FEN before attempting player's move

                if (target === null) { // This means it's a click-to-move second click context
                    let square = source; // 'source' is actually the target square here from onSquareClick's context
                    if (squareSelected === null) {
                        // This case should ideally not happen if logic in onSquareClick is strict
                        return; 
                    }
                    // Clear highlights from previous selection
                    $('#myBoard .square-' + squareSelected).removeClass('highlight-selected');
                    game.moves({ square: squareSelected, verbose: true }).forEach(move => {
                        $('#myBoard .square-' + move.to).removeClass('highlight-legal-move');
                    });


                    moveResult = game.move({ from: squareSelected, to: square, promotion: 'q' });
                    squareSelected = null; // Clear selection
                } else { // This is a drag-to-move context (onDrop calls with source and target)
                    moveResult = game.move({ from: source, to: target, promotion: 'q' });
                }

                if (moveResult === null) {
                    updateStatus("Illegal move! Try again.", false);
                    board.position(game.fen()); // Snapback visual state
                    return 'snapback'; // For drag/drop, return 'snapback'
                }
                
                board.position(game.fen()); // Update board position immediately

                // Check if it's the correct book move
                const correctMoveSAN = currentOpeningMoves[currentMoveIndex];
                
                if (moveResult.san === correctMoveSAN) {
                    currentMoveIndex++;
                    updateStatus(`Correct! Move: ${moveResult.san} <span class="feedback-book">(Book Move)</span>`, true);

                    if (currentMoveIndex < currentOpeningMoves.length) {
                        // Computer (Black) plays the next book move
                        setTimeout(makeComputerMoveInBookMode, 500); 
                    } else { 
                        // Opening complete, transition to 2-Player mode
                        updateStatus("Opening complete! Well done! Switching to Two-Player Mode!", true);
                        twoPlayerModeActive = true; 
                        $startTwoPlayerBtn.hide(); // Hide the start 2-player button as it's auto-activated
                        $statusMove.append(`<br>Player ${game.turn() === 'w' ? 'White' : 'Black'}'s turn.`);
                        displayEvaluation(null, null, null); // Clear eval and show "Game In Progress"
                    }
                    return true; // Indicate successful move processing
                } else {
                    updateStatus(`Incorrect. The book move is ${correctMoveSAN}. Try again.`, false);
                    game.undo(); // Undo the incorrect move
                    board.position(game.fen()); // Reset board visually
                    return 'snapback'; 
                }
            }

            // onDrop is for drag-and-drop actions only
            function onDrop(source, target) {
                // If game is over, no moves allowed
                if (game.game_over()) {
                    updateStatus("Game is over!", false);
                    return 'snapback';
                }
                
                // If book moves are active, only playerColor can move (White)
                if (currentMoveIndex < currentOpeningMoves.length) {
                    if (game.turn() !== playerColor) {
                        updateStatus("It's not your turn to play book moves! You are White.", false);
                        return 'snapback';
                    }
                    return handlePlayerMoveInBookMode(source, target); // Pass to book mode handler
                } 
                
                // If book moves are complete (Two-Player Mode)
                // In two-player free play, current game.turn() decides who can move
                if (game.get(source) && game.get(source).color !== game.turn()) {
                    updateStatus(`It's not ${game.turn() === 'w' ? 'White' : 'Black'}'s turn!`, false);
                    return 'snapback';
                }

                // Proceed with normal two-player drag-and-drop
                let move = game.move({ from: source, to: target, promotion: 'q' });

                if (move === null) {
                    updateStatus("Illegal move! Try again.", false);
                    return 'snapback';
                }
                
                board.position(game.fen()); // Update visual board
                updateStatus(`Move: ${move.san}`);
                if (!game.game_over()) {
                    // In 2-player mode, just switch turns and update status
                    $statusMove.text(`Player ${game.turn() === 'w' ? 'White' : 'Black'}'s turn.`);
                } else {
                    handleGameOver();
                }
                return true; 
            }

            // This function handles Computer's turn ONLY in Book Mode
            function makeComputerMoveInBookMode() {
                if (game.game_over()) {
                    handleGameOver();
                    return;
                }
                // Check if it's Black's turn (Computer in book mode is always Black if player is White)
                if (game.turn() === 'b' && currentMoveIndex < currentOpeningMoves.length) {
                    const moveSAN = currentOpeningMoves[currentMoveIndex];
                    console.log('Computer (Black) making book move:', moveSAN);
                    const moveResult = game.move(moveSAN, { sloppy: true });
                    if (moveResult === null) {
                        console.error("Computer tried to make an illegal move (from book):", moveSAN, "from FEN:", game.fen());
                        updateStatus("Error in opening data! Computer tried an illegal move. Reset board.", false);
                        return;
                    }
                    board.position(game.fen());
                    currentMoveIndex++;
                    updateStatus(`Computer plays: ${moveSAN} <span class="feedback-book">(Book Move)</span>`);
                    
                    if (currentMoveIndex >= currentOpeningMoves.length) {
                        // Opening complete, transition to 2-Player mode
                        updateStatus("Opening complete! Well done! Switching to Two-Player Mode!", true);
                        twoPlayerModeActive = true; 
                        $startTwoPlayerBtn.hide(); // Hide the start 2-player button as it's auto-activated
                        $statusMove.append(`<br>Player ${game.turn() === 'w' ? 'White' : 'Black'}'s turn.`);
                        displayEvaluation(null, null, null); // Clear eval and show "Game In Progress"
                    } else if (game.turn() === playerColor) { // It's player's turn (White) for next book move
                        updateStatus('Your turn.');
                    } else { // It's still Black's turn for another book move (unlikely in standard openings)
                        setTimeout(makeComputerMoveInBookMode, 500);
                    }
                } else {
                    // This case should ideally not be hit if makeComputerMoveInBookMode is only called for Black's turn in book.
                    console.log("Not computer's book move turn. Skipping makeComputerMoveInBookMode.");
                }
            }


            function handleGameOver() {
                if (game.in_checkmate()) {
                    updateStatus(`Game Over! Checkmate. ${game.turn() === 'w' ? 'Black' : 'White'} wins!`, true);
                } else if (game.in_stalemate()) {
                    updateStatus("Game Over! Stalemate. It's a draw.", false);
                } else if (game.in_draw()) {
                    updateStatus("Game Over! Draw.", false);
                } else if (game.in_threefold_repetition()) {
                    updateStatus("Game Over! Draw by threefold repetition.", false);
                } else if (game.insufficient_material()) {
                    updateStatus("Game Over! Draw by insufficient material.", false);
                }
                twoPlayerModeActive = false; // Ensure 2-player mode is off
                $startTwoPlayerBtn.hide(); // Hide the button on game over
                $evaluationDisplay.empty(); 
                updateWinMeter(50); // Reset meter to even
                console.log('Game Over. All states cleared.');
            }

            function updateStatus(text, isCorrect) {
                $statusMove.html(text); // Use .html() to allow span tags
                $boardElement.removeClass('highlight-correct highlight-incorrect');
                if (isCorrect === true) { $boardElement.addClass('highlight-correct'); }
                else if (isCorrect === false) { $boardElement.addClass('highlight-incorrect'); }
                
                // Keep the highlight for these specific messages, otherwise fade it
                if (text.includes("Opening complete") || text.includes("Game Over") || text.includes("Computer is thinking") || text.includes("Analyzing...")) {
                    // Do not remove highlight
                } else {
                    if (thinkingProcess) clearTimeout(thinkingProcess); // Clear any pending status update clears
                    thinkingProcess = setTimeout(() => $boardElement.removeClass('highlight-correct highlight-incorrect'), 1200);
                }
            }

            function startPractice() {
                console.log('Starting new practice...');
                game = new Chess();
                currentMoveIndex = 0;
                playerColor = $playerColorSelect.val(); // User selected color for book moves
                twoPlayerModeActive = false; // Start in book mode, not 2-player mode
                $startTwoPlayerBtn.hide(); // Hide button initially
                $evaluationDisplay.empty(); 
                updateWinMeter(50); // Reset meter to even
                
                const selectedCategory = $categorySelect.val();
                const selectedOpening = $openingSelect.val();
                const selectedVariation = $variationSelect.val();
                if (!selectedCategory || !selectedOpening || !selectedVariation) { alert("Please select a complete opening line."); return; }
                currentOpeningMoves = openingBook[selectedCategory][selectedOpening][selectedVariation];
                
                const boardConfig = {
                    draggable: true, 
                    position: 'start', 
                    onDrop: onDrop,
                    onSquareClick: onSquareClick, // Enable click-to-move
                    orientation: playerColor === 'w' ? 'white' : 'black', // Orient board as selected player
                    pieceTheme: 'chesspieces/wikipedia/{piece}.png'
                };
                $('#myBoard').empty();
                board = Chessboard('myBoard', boardConfig); 
                $(window).off('resize').on('resize', board.resize);
                $statusOpening.text(`${selectedOpening}: ${selectedVariation}`);

                displayEvaluation(null, null, null); // Clear eval display and show game in progress

                // Determine who makes the first move (based on book and playerColor)
                if (playerColor === 'w' && game.turn() === 'w') { // Player is White, it's White's turn
                    updateStatus('Practice started. Your turn (White).');
                } else if (playerColor === 'b' && game.turn() === 'w') { // Player is Black, White (opponent) moves first
                    updateStatus('Practice started. Opponent (White) to move first (Book move).');
                    setTimeout(makeComputerMoveInBookMode, 500); // Opponent (White) makes book move
                } else { // Should default to player's turn if no book move to make for opponent
                    updateStatus('Practice started. Your turn (White).', true); // Default to player's turn (White)
                }
            }

            // --- Undo Functionality ---
            function undoLastMove() {
                if (game.history().length === 0) {
                    updateStatus("No moves to undo!", false);
                    return;
                }

                // If currently in book mode, undo 1 move at a time
                if (currentMoveIndex < currentOpeningMoves.length) {
                    game.undo();
                    if (currentMoveIndex > 0) currentMoveIndex--; // Decrement if not first move
                    updateStatus(`1 move undone.`, true);
                } else { // After book moves (2-player mode)
                    let lastMove = game.history()[game.history().length - 1];
                    game.undo(); // Undo current player's move
                    updateStatus(`1 move undone.`, true);
                    // If it was black's turn to move, it means white just moved.
                    // If it was white's turn to move, it means black just moved.
                    // So, simply state whose turn it is now.
                }
                
                board.position(game.fen());
                // Update status for 2-player mode after undo
                if (currentMoveIndex >= currentOpeningMoves.length) {
                    $statusMove.text(`Player ${game.turn() === 'w' ? 'White' : 'Black'}'s turn.`);
                }
                displayEvaluation(null, null, null); // Clear eval and show "Game In Progress"
                updateWinMeter(50); // Reset meter for 2-player
            }

            $undoBtn.on('click', undoLastMove); // Assign click handler

            $startBtn.on('click', startPractice);
            $resetBtn.on('click', () => {
                board.start();
                game.reset();
                currentMoveIndex = 0; 
                twoPlayerModeActive = false;
                $startTwoPlayerBtn.hide(); // Hide the 2-player button
                $statusOpening.text("Board Reset");
                $statusMove.text("Select an opening and start.");
                $evaluationDisplay.empty();
                updateWinMeter(50); // Reset meter
                console.log('Board reset. All states cleared.');
            });

            // This button now transitions to 2-Player mode AFTER book moves
            $startTwoPlayerBtn.on('click', () => {
                if (currentMoveIndex < currentOpeningMoves.length) {
                    updateStatus("Two-Player Mode can only be started after book moves are complete!", false);
                    return;
                }
                twoPlayerModeActive = true; 
                $startTwoPlayerBtn.hide(); 
                console.log('Transitioned to Two-Player Mode.');
                updateStatus(`Two-Player Mode Activated! Player ${game.turn() === 'w' ? 'White' : 'Black'}'s turn.`, true);
                displayEvaluation(null, null, null); // Clear eval for 2-player
                updateWinMeter(50); // Center meter for 2-player
            });

            // Handle window resize to adjust win meter orientation
            $(window).resize(() => {
                updateWinMeter(50); // Keep meter centered for 2-player/no-AI mode
            });

            populateCategories();
            const initialConfig = { 
                draggable: true, 
                position: 'start', 
                onDrop: onDrop,
                onSquareClick: onSquareClick, // Enable click-to-move
                orientation: playerColor === 'w' ? 'white' : 'black', // Initial orientation
                pieceTheme: 'chesspieces/wikipedia/{piece}.png'
            };
            board = Chessboard('myBoard', initialConfig); 
            $(window).resize(board.resize);
            updateWinMeter(50); // Initial meter state on first load
        });
    </script>

</body>
</html>